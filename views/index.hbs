<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
    <title>HelperBot</title>

    <!-- Might want to get bootstrap and jquery in js and css file in public to keep it local -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="/stylesheets/style.css"></link>
    <!-- Might not need the stylesheet if not working -->
    <script type="text/javascript" src="/js/script.js"></script>
  </head>
  <body>
    <a href="/logout" class="logout" role="button">Logout</a>
<br/>

  <center><h1 style="color:white">Welcome, Thanh Nguyen!</h1></center>
  <p id='userName' hidden>Thanh Nguyen</p>
  <br/>
<div style="margin-left:25%">
  <div style="display:inline-block;margin-right:5%;color:white;font-size:20px;">
    <img class="taPic" src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTZdaIj40vlNy5-KRzeRtBc4nQO3qohNEQdfJydorNEXmUVwVyn"> &nbsp;&nbsp;&nbsp;&nbsp;No current jobs</img>
  </div>
  <br/>
  <br/>

  <!--<label class="switch" style="margin-left:2%">
    <input id="toggle" type="checkbox">
    <span class="slider round"></span>
  </label>-->
  <button id="toggle" class="btn btn-warning">Availability</button>

</div>

<br/>
<br/>

<div id="assignedAlert">
  <!--<center><div class="alert alert-success" style="width:50%">
    <strong>Heads up!</strong> You've been assigned to TA.
  </div></center>-->
</div>

<div id="queue" class="queueBody" style="height:300px;width:50%;max-height:96%;overflow:auto">
</div>
<br/>

<script>
  //load ta and queue --> getAssignments
  $(document).ready(function() {
    var user = null;
    $.ajax({
      url: 'https://ronchon-maison-19725.herokuapp.com/getUser',
      method: 'get',
      success: function(theUser) {
        user = theUser;
        if (!theUser.isStudent && theUser.available) {
          $('#toggle').attr('class', 'btn btn-success');
        } else {
          $('#toggle').attr('class', 'btn btn-warning');
        }
      }
    });

    $.ajax({
      url: 'https://ronchon-maison-19725.herokuapp.com/getAssignments',
      method:'get',
      success: function(resp) {
        var tas = resp.tas;
        var queue = resp.queue;
        console.log('tas: ' + tas);
        $('.tas').empty();
        $('#queue').empty();
        tas.forEach(function(ta) {
          //render each ta
          if (ta.assignedTo.equals(user._id)) {
            Ta.findOne({assignedTo:user._id}, function(err, ta) {
              if (err) {
                console.log(err);
              } else {
                $('#assignedAlert').append(`<center><div class="alert alert-success" style="width:50%">
                  <strong>Heads up!</strong> You've been assigned to ${ta.username}.
                </div></center>`);
              }
            });
          }
          $('.tas').append(`<div style="display:inline-block;margin-right:5%">
            <img class="taPic" src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTZdaIj40vlNy5-KRzeRtBc4nQO3qohNEQdfJydorNEXmUVwVyn"></img>
            <p class="text-with-img">${ta.username} <i style="color:red" class="fa fa-circle" aria-hidden="true"></i></p>
          </div>`);
        });
        queue.forEach(function(student) {
          $('#queue').append(`<div class="panel panel-default">
          <div class="panel-heading">${student.username} <i id='cancel' style="float:right;color:red" class="fa fa-times-circle" aria-hidden="true"></i></div>
          <div class="panel-body"><strong>${student.category}</strong>: ${student.description}</div>
          </div>`);
        });
      }
    });

    $('#addToQueue').on('click', function(evt) {
      evt.preventDefault();
      console.log('description: ' + $('#desc').val());
      console.log('category: ' + $('#category').val());
      $.ajax({
        url: 'https://ronchon-maison-19725.herokuapp.com/add',
        method:'post',
        data: {
          description: $('#desc').val(),
          category: $('#category').val()
        },
        success: function(resp) {
          var queue = resp['queue'];
          $('#queue').empty();
          $('#desc').val('');
          $('#category').val('');
          for (var i = 0; i < queue.length; i++) {
            if ($('#userName').text() === queue[i].username) {
              console.log('username text: ' + $('#userName').text());
              $('#queue').append(`<div class="panel panel-default">
              <div class="panel-heading">${queue[i].username} <i id='cancel' style="float:right;color:red" class="fa fa-times-circle" aria-hidden="true"></i></div>
              <div class="panel-body"><strong>${queue[i].category}</strong>: ${queue[i].description}</div>
              </div>`);
            } else {
              $('#queue').append(`<div class="panel panel-default">
              <div class="panel-heading">${queue[i].username}</div>
              <div class="panel-body"><strong>${queue[i].category}</strong>: ${queue[i].description}</div>
              </div>`);
            }
          }
          console.log('response from request: ' + JSON.stringify(resp));
          $("#addToQueue").prop("disabled",true);
        }
      });
    });

    $('#queue').on('click', '#cancel', function () {
      console.log('Cancel!');
      $.ajax({
        url: 'https://ronchon-maison-19725.herokuapp.com/cancel',
        method: 'get',
        success: function(resp) {
          $('#queue').empty();
          var queue = resp['queue'];
          console.log('response queue: ' + queue);
          for (var i = 0; i < queue.length; i++) {
            if ($('#userName').text() === queue[i].username) {
              console.log('username text: ' + $('#userName').text());
              $('#queue').append(`<div class="panel panel-default">
              <div class="panel-heading">${queue[i].username} <i id='cancel' style="float:right;color:red" class="fa fa-times-circle" aria-hidden="true"></i></div>
              <div class="panel-body"><strong>${queue[i].category}</strong>: ${queue[i].description}</div>
              </div>`);
            } else {
              $('#queue').append(`<div class="panel panel-default">
              <div class="panel-heading">${queue[i].username}</div>
              <div class="panel-body"><strong>${queue[i].category}</strong>: ${queue[i].description}</div>
              </div>`);
            }
          }
          $("#addToQueue").prop("disabled",false);
        }
      })
     });

    $('#getPass').on('click', function(evt) {
      console.log('Get pass!');
    });

    $('#toggle').on('click', function(evt) {
      console.log('toggle button clicked!');
      if ($('toggle').attr('class') === 'btn btn-warning') {
        $('#toggle').attr('class', 'btn btn-success')
      } else {
        $('#toggle').attr('class', 'btn btn-warning')
      }
      $.ajax({
        url: 'https://ronchon-maison-19725.herokuapp.com/changeStatus',
        method: 'post',
        success: function(resp) {
        }
      });
    });

    setInterval(function() {
      var currentHour = (new Date()).getHours();
      if (currentHour === 0) {
        // make post request to reset
        $.ajax({
          url:"https://ronchon-maison-19725.herokuapp.com/reset",
          method:'get',
          success: function(resp) {
            //change the queue and the TAs
          }
        })
      }
    }, 1000*60*60);

    setInterval(function() {
      //update with new tas and queue status
      $.ajax({
        url: 'https://ronchon-maison-19725.herokuapp.com/getAssignments',
        method:'get',
        success: function(resp) {
          var tas = resp.tas;
          var queue = resp.queue;
          console.log('tas: ' + JSON.stringify(tas));
          $('.tas').empty();
          $('#queue').empty();
          tas.forEach(function(ta) {
            //render each ta
            if (ta.available) {
              $('.tas').append(`<div style="display:inline-block;margin-right:5%">
                <img class="taPic" src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTZdaIj40vlNy5-KRzeRtBc4nQO3qohNEQdfJydorNEXmUVwVyn"></img>
                <p class="text-with-img">${ta.username}<i style="color:green" class="fa fa-circle" aria-hidden="true"></i></p>
              </div>`)
            } else {
              $('.tas').append(`<div style="display:inline-block;margin-right:5%">
                <img class="taPic" src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTZdaIj40vlNy5-KRzeRtBc4nQO3qohNEQdfJydorNEXmUVwVyn"></img>
                <p class="text-with-img">${ta.username}<i style="color:red" class="fa fa-circle" aria-hidden="true"></i></p>
              </div>`);
            }
          });
          queue.forEach(function(student) {
            $('#queue').append(`<div class="panel panel-default">
            <div class="panel-heading">${student.username} <i id='cancel' style="float:right;color:red" class="fa fa-times-circle" aria-hidden="true"></i></div>
            <div class="panel-body"><strong>${student.category}</strong>: ${student.description}</div>
            </div>`);
          });
        }
      });
    }, 5000);
  });
</script>

  </body>
</html>
